---
# PayFlux Kubernetes Deployment
# Single-replica deployment for observability buffer
# Assumes external Redis (configure REDIS_ADDR)

apiVersion: v1
kind: ConfigMap
metadata:
  name: payflux-config
  namespace: default
data:
  REDIS_ADDR: "redis.default.svc.cluster.local:6379"
  HTTP_ADDR: ":8080"
  PAYFLUX_EXPORT_MODE: "stdout"
  PAYFLUX_RATELIMIT_RPS: "100"
  PAYFLUX_RATELIMIT_BURST: "500"
  PAYFLUX_STREAM_MAXLEN: "200000"
  PAYFLUX_PANIC_MODE: "crash"
  PRICE_CENTS: "9900"
  PRODUCT_NAME: "PayFlux Early Access"
  SITE_URL: "https://payflux.dev"

---
apiVersion: v1
kind: Secret
metadata:
  name: payflux-secrets
  namespace: default
type: Opaque
stringData:
  PAYFLUX_API_KEY: "your-api-key-here"
  STRIPE_API_KEY: "sk_live_your_stripe_key_here"

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: payflux
  namespace: default
automountServiceAccountToken: false

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: payflux
  namespace: default
  labels:
    app: payflux
spec:
  replicas: 1  # Single replica by default; scale horizontally as needed
  selector:
    matchLabels:
      app: payflux
  template:
    metadata:
      labels:
        app: payflux
    spec:
      serviceAccountName: payflux
      automountServiceAccountToken: false
      # Enforce non-root execution (aligns with Dockerfile USER directive)
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
      - name: payflux
        image: payflux:latest  # Replace with your registry/image
        imagePullPolicy: IfNotPresent
        ports:
        - name: http
          containerPort: 8080
          protocol: TCP
        env:
        # Load config from ConfigMap
        - name: REDIS_ADDR
          valueFrom:
            configMapKeyRef:
              name: payflux-config
              key: REDIS_ADDR
        - name: HTTP_ADDR
          valueFrom:
            configMapKeyRef:
              name: payflux-config
              key: HTTP_ADDR
        - name: PAYFLUX_EXPORT_MODE
          valueFrom:
            configMapKeyRef:
              name: payflux-config
              key: PAYFLUX_EXPORT_MODE
        - name: PAYFLUX_RATELIMIT_RPS
          valueFrom:
            configMapKeyRef:
              name: payflux-config
              key: PAYFLUX_RATELIMIT_RPS
        - name: PAYFLUX_RATELIMIT_BURST
          valueFrom:
            configMapKeyRef:
              name: payflux-config
              key: PAYFLUX_RATELIMIT_BURST
        - name: PAYFLUX_STREAM_MAXLEN
          valueFrom:
            configMapKeyRef:
              name: payflux-config
              key: PAYFLUX_STREAM_MAXLEN
        - name: PAYFLUX_PANIC_MODE
          valueFrom:
            configMapKeyRef:
              name: payflux-config
              key: PAYFLUX_PANIC_MODE
        - name: PRICE_CENTS
          valueFrom:
            configMapKeyRef:
              name: payflux-config
              key: PRICE_CENTS
        - name: PRODUCT_NAME
          valueFrom:
            configMapKeyRef:
              name: payflux-config
              key: PRODUCT_NAME
        - name: SITE_URL
          valueFrom:
            configMapKeyRef:
              name: payflux-config
              key: SITE_URL
        # Load secrets from Secret
        - name: PAYFLUX_API_KEY
          valueFrom:
            secretKeyRef:
              name: payflux-secrets
              key: PAYFLUX_API_KEY
        - name: STRIPE_API_KEY
          valueFrom:
            secretKeyRef:
              name: payflux-secrets
              key: STRIPE_API_KEY
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: payflux
  namespace: default
  labels:
    app: payflux
spec:
  type: ClusterIP
  ports:
  - port: 8080
    targetPort: 8080
    protocol: TCP
    name: http
  selector:
    app: payflux
