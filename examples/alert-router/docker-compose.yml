# PayFlux + Alert Router Example Stack
#
# This runs PayFlux with pilot mode enabled, along with the optional
# alert router sidecar. The router polls PayFlux for warnings and
# routes alerts to Slack or a generic webhook.
#
# Usage:
#   docker compose up --build
#
# Required environment variables (set in .env or export):
#   PAYFLUX_API_KEY - API key for PayFlux
#   STRIPE_API_KEY - Stripe API key (sk_test_xxx)
#   SLACK_WEBHOOK_URL - (if using Slack sink)
#   ALERT_WEBHOOK_URL - (if using webhook sink)

version: "3.8"

services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3

  payflux:
    build:
      context: ../..
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - REDIS_ADDR=redis:6379
      - PAYFLUX_API_KEY=${PAYFLUX_API_KEY:-dev-secret-key}
      - STRIPE_API_KEY=${STRIPE_API_KEY}
      - PAYFLUX_PILOT_MODE=true
      - PAYFLUX_TIER=tier1
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 3

  alert-router:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      # Router enable switch (default disabled)
      - PAYFLUX_ALERT_ROUTER_ENABLED=${PAYFLUX_ALERT_ROUTER_ENABLED:-false}
      
      # PayFlux connection
      - PAYFLUX_BASE_URL=http://payflux:8080
      - PAYFLUX_PILOT_AUTH=${PAYFLUX_API_KEY:-dev-secret-key}
      
      # Alert sink configuration
      - ALERT_SINK=${ALERT_SINK:-slack}
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
      - ALERT_WEBHOOK_URL=${ALERT_WEBHOOK_URL:-}
      
      # Optional dashboard link
      - PAYFLUX_DASHBOARD_URL=${PAYFLUX_DASHBOARD_URL:-http://localhost:8080/pilot/dashboard}
      
      # Tuning (all optional)
      - POLL_INTERVAL_SECONDS=${POLL_INTERVAL_SECONDS:-15}
      - ALERT_MIN_BAND=${ALERT_MIN_BAND:-elevated}
      - ALERT_MAX_PER_HOUR=${ALERT_MAX_PER_HOUR:-30}
      - DEDUPE_TTL_SECONDS=${DEDUPE_TTL_SECONDS:-86400}
    depends_on:
      payflux:
        condition: service_healthy
    restart: unless-stopped
