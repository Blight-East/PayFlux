groups:
  - name: payflux_ops
    rules:
      # PayFlux process is down
      - alert: PayFluxDown
        expr: up{job="payflux"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PayFlux is down"
          description: "PayFlux process has been unreachable for more than 1 minute."

      # Consumer lag is high (events piling up in Redis stream)
      # Threshold is configurable - default 1000 messages
      - alert: ConsumerLagHigh
        expr: payflux_consumer_lag_messages > 1000
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "PayFlux consumer lag is high"
          description: "Consumer lag has exceeded 1000 messages for 2 minutes. Current: {{ $value }} messages."

      # Rate limiting is being triggered frequently
      - alert: RateLimitingSpike
        expr: sum(rate(payflux_ingest_rate_limited_total[5m])) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PayFlux rate limiting spike"
          description: "Rate limiting is triggering more than 5 times per second for 5 minutes."

      # Ingest rejections are spiking (bad payloads or auth issues)
      - alert: IngestRejectSpike
        expr: rate(payflux_ingest_rejected_total[5m]) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PayFlux ingest rejections spiking"
          description: "More than 1 ingest rejection per second over 5m window."

      # Warnings are being suppressed (dedup or rate limit on warning storage)
      - alert: WarningsSuppressed
        expr: increase(payflux_warnings_suppressed_total[5m]) > 0
        for: 0m
        labels:
          severity: info
        annotations:
          summary: "PayFlux warnings being suppressed"
          description: "Some warnings were suppressed in the last 5 minutes. Count: {{ $value }}."

      # Auth denials are spiking (possible attack, config issue, or key rotation)
      - alert: PayFluxAuthDeniedSpike
        expr: sum(increase(payflux_auth_denied_total[5m])) > 50
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PayFlux auth denials spiking"
          description: |
            More than 50 auth denials in 5 minutes.
            
            Breakdown by reason:
            {{ range query "sum by (reason) (increase(payflux_auth_denied_total[5m]))" }}
              - {{ .Labels.reason }}: {{ .Value }}
            {{ end }}
            
            Response guidance:
            - missing_key: Clients missing Bearer token or integration regression
            - revoked_key: Leaked key still in use after rotation
            - invalid_key: Wrong key deployed or rotation mismatch
            
            See docs/AUTH_DENIAL_METRICS.md for detailed response procedures.

      # Revoked key still being used (potential security incident)
      - alert: RevokedKeyInUse
        expr: increase(payflux_auth_denied_total{reason="revoked_key"}[5m]) > 5
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Revoked API key still in use"
          description: |
            A revoked API key has been attempted {{ $value }} times in the last 5 minutes.
            
            This indicates either:
            1. Slow client migration after planned key rotation (expected for 24-48h)
            2. Compromised key still being used by attacker (SECURITY INCIDENT)
            
            Immediate actions:
            1. Check when key was added to PAYFLUX_REVOKED_KEYS
            2. If recent rotation (<48h ago): Monitor, expected to decline
            3. If unexpected: Review security logs, identify source, escalate
            4. Cross-reference with invalid_key attempts for brute-force patterns
            
            See docs/AUTH_DENIAL_METRICS.md for full incident response procedures.
